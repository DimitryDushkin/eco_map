<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Переработай это! {% block title %}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/static/main.css" rel="stylesheet">
    
    <style type="text/css">
	  html { height: 100% }
	  body { height: 100%; margin: 0; padding: 0}
	  .container-fluid {padding-right: 0}
	  #map_canvas { height: 100% }
	  .left-menu {margin-top: 15px}
	</style>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/static/bootstrap/js/jquery-1.7.1.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBwryvM3ZbNqfK9L6euanMsXxdwccIhXqs&sensor=true">
    </script>

<script>
	/*
	Google Maps:
	Key for browser apps (with referers)
	API key:	
	AIzaSyBwryvM3ZbNqfK9L6euanMsXxdwccIhXqs
	
	GFT:
	Name:	recycle-map
	Numeric ID:	4302955
	Encrypted ID:	1gvB3SedL89vG5r1128nUN5ICyyw7Wio5g1w1mbk}
	*/
var map, layer;
var tableId = '1gvB3SedL89vG5r1128nUN5ICyyw7Wio5g1w1mbk';
var locationColumnName = 'Location';

$(function(){
	var myOptions = {
      center: new google.maps.LatLng(55.74975, 37.623641),
      zoom: 11,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"),
        	  myOptions);
    layer = new google.maps.FusionTablesLayer({
		query: {
			select: locationColumnName,
			from: tableId
		}
	});
	layer.setMap(map);
	
	
	// ============ On checkboxes click ====================
	// Show only points with checked types
	$('.choose-waste [type="checkbox"]').click(function(){
		var selected_waste_types = ''
		// collect data from each checked checkbox
		$('.choose-waste [type="checkbox"]').each(function(){
			if ($(this).attr('checked'))
				selected_waste_types += ' ' + $(this).val() + ' =  1,';
		});
		// remove last comma
		selected_waste_types = selected_waste_types.slice(0, -1)
		// update fusion table layer
		layer.setOptions({
			query: {
				select: locationColumnName,
				from: tableId,
				where: selected_waste_types
			}
		});
	});
	// END ============ On checkboxes click ====================
	
	
	// ============ Try to get current location ====================
	if (navigator.geolocation)
		navigator.geolocation.getCurrentPosition(function (position) {
	        var coords = new google.maps.LatLng(position.coords.latitude,
	        									position.coords.longitude);
			map.setCenter(coords);
			map.setZoom(15);
			var marker = new google.maps.Marker({
				position: coords,
				map: map,
				title: 'Ваше текущее месторасположение',
				icon: '/static/img/icon_home.png'
			});
		});
	// END ============ Try to get current location ====================	
	
	
	//===== Set map canvas always to 100% height ========
	var wheight = $(window).height();
	$('#map_canvas').height(wheight);
	$(window).resize(function(){
		var wheight = $(this).height();
		$('#map_canvas').height(wheight);
	});
	// END ===== Set map canvas always to 100% height ========	
});
</script> 
  </head>
  <body>
	<div class="container-fluid">
      <div class="row-fluid">
        <div class="span3 left-menu">
          <h2>Переработай это!</h2>
		  <div class="well choose-waste">
	          <h3>Выберите типы отходов:</h3> <br>
	          <label class="checkbox">
	            <input type="checkbox" value="Paper">
	            Бумага
	          </label>
	          <label class="checkbox">
	            <input type="checkbox" value="Metall">
	            Металл
	          </label>
          </div><!--/.well -->
        </div>
        <!--/ left span-->
        <div class="span9">
        	<div id="map_canvas" style="width:100%; height: 600px"></div>
        </div>
        <!--/ right span-->
	</div>
	<!--/ container -->
  </body>
</html>